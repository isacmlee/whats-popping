<!DOCTYPE HTML>

<html>
	<head>
		<title>what's popping?</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="../static/css/main.css" />
	</head>


	<!-- body -->
	<body id="redirect">
        <div id="pageHeader">
            <div id="logoHeader">
                <img src="../static/images/websiteIcon.png" alt="icon" width="40" height="40">
            </div>
            <div id="pageHeaderInner"> 
                <h1>What's Popping</h1>
            </div>
        </div>
        <div id="description">
            <p>What's Popping uses a song's genre, popularity, danceability, and instrumentalness to predict your next favorite song with a Random Forest model. </p>
         </div>
        <div id="buttonArray">
            <div id="buttonOne">
                <button id="start-model-job" class="small-btn"> Get Recommendations </button>
            </div>
            <div id="buttonTwo">
                <button id="start-playlist-creation-job" class="small-btn"> Add to Spotify </button>
            </div>
        </div>
        
        <br>
        <br>
        <br>
        <br>
        <div id="loading-gif">
            <img id="loading_img" src="../static/images/loading2.gif" style="display:none"/>
        </div>
        <div id="progress">

        </div>
       
    

		<!-- Scripts -->
		<script src="//cdnjs.cloudflare.com/ajax/libs/nanobar/0.2.1/nanobar.min.js"></script>
		<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
		<script>
            // Asynchronous 1 - Run Model 
            function start_model_task() {
                $('#loading_img').show();
                // add task status elements
                $('#progress').empty()
                div = $('<div class="progress"><div></div><div>&nbsp;</div></div>');
                $('#progress').append(div);

                // send ajax POST request to start background job
                $.ajax({
                    type: 'POST',
                    url: '/model_task',
                    success: function(data, status, request) {
                        status_url = request.getResponseHeader('Location');
                        update_progress(status_url, div[0]);
                    },
                    error: function() {
                        alert('Unexpected error');
                    }
                });
            }
            function update_progress(status_url, status_div) {
                // send GET request to status URL
                $.getJSON(status_url, function(data) {
                    // update UI
                    $(status_div.childNodes[0]).text(data['status']);
                    if (data['state'] != 'PENDING' && data['state'] != 'PROGRESS') {
                        if ('result' in data) {
                            // show result
                            $(status_div.childNodes[1]).text("Model Complete");
                        }
                        else {
                            // Success
                            $("#progress").empty();
                            $("#loading_img").hide();
                            $("#start-model-job").html('Created recs');
;
                        }
                    }
                    else {
                        // rerun in 2 seconds
                        setTimeout(function() {
                            update_progress(status_url, status_div);
                        }, 2000);
                    }
                });
            }
            
            // Asynchronous 2 - Create Spotify Playlist  
            function start_playlist_task() {
                $("#start-playlist-creation-job").html('Added.');
                // send ajax POST request to start background job
                $.ajax({
                    type: 'POST',
                    url: '/playlist_creation',
                    success: function(data) {
                       success = 'Playlist has been successfully created.'
                    },
                    error: function() {
                        alert('Unexpected error');
                    }
                });
            }

            $(function() {
                $('#start-model-job').click(start_model_task);
            });

            $(function() {
                $('#start-playlist-creation-job').click(start_playlist_task);
            })
        </script>
	</body>
</html>
